<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lootbox Vendor - Products</title>
    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
      :root {
        --lootbox-purple: #7c3aed;
        --lootbox-purple-light: #ede9fe;
        --lootbox-gradient: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);
        --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --sidebar-width: 250px;
      }

      body {
        font-family: "Montserrat", sans-serif;
        background-color: #f8fafc;
      }

      /* Sidebar Styles */
      .sidebar {
        width: var(--sidebar-width);
        height: 100vh;
        position: fixed;
        left: 0;
        top: 0;
        background: #e9e5ff;
        border-right: 1px solid #e5e7eb;
        box-shadow: 0px 0px 20px rgb(188 188 188);
        padding: 1rem;
        transition: transform 0.3s ease-in-out;
        z-index: 1000;
      }

      .main-content {
        margin-left: var(--sidebar-width);
        min-height: 100vh;
      }

      .nav-link {
        color: #64748b;
        padding: 0.75rem 1rem;
        border-radius: 0.375rem;
        margin: 0.25rem 0;
        transition: all 0.2s ease;
      }

      .nav-link:hover,
      .nav-link.active {
        background-color: var(--lootbox-purple-light);
        color: var(--lootbox-purple);
      }

      .nav-link.active {
        background-color: var(--lootbox-purple);
        color: white;
      }

      /* Navbar */
      .navbar {
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        background: white;
      }

      /* Page Header */
      .page-header {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: var(--card-shadow);
        margin-bottom: 1.5rem;
      }

      /* Stats Cards */
      .stats-card {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: var(--card-shadow);
        border: none;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        height: 100%;
      }

      .stats-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
      }

      .stats-card .icon-container {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1rem;
      }

      .stats-card .products-icon {
        background-color: rgba(124, 58, 237, 0.1);
        color: var(--lootbox-purple);
      }

      .stats-card .sales-icon {
        background-color: rgba(16, 185, 129, 0.1);
        color: #10b981;
      }

      .stats-card .stock-icon {
        background-color: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
      }

      .stats-card .value-icon {
        background-color: rgba(245, 158, 11, 0.1);
        color: #f59e0b;
      }

      .stats-card h3 {
        font-weight: 700;
        margin-bottom: 0.5rem;
        color: #1f2937;
      }

      /* Product Card */
      .product-card {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: var(--card-shadow);
        transition: all 0.3s ease;
        height: 100%;
      }

      .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
      }

      .product-card .img-container {
        position: relative;
        padding-top: 75%; /* 4:3 Aspect Ratio */
        overflow: hidden;
      }

      .product-card .img-container img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
      }

      .product-card:hover .img-container img {
        transform: scale(1.05);
      }

      .product-card .status-badge {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        z-index: 1;
        padding: 0.5rem 0.75rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
      }

      .product-card .card-body {
        padding: 1.25rem;
      }

      .product-card .card-title {
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 0.5rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .product-card .card-text {
        color: #6b7280;
        font-size: 0.875rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        margin-bottom: 1rem;
      }

      .product-price {
        font-weight: 700;
        color: var(--lootbox-purple);
        font-size: 1.1rem;
      }

      .product-stock {
        font-size: 0.875rem;
        color: #6b7280;
      }

      .product-meta {
        font-size: 0.75rem;
        color: #9ca3af;
      }

      /* Action Buttons */
      .action-buttons {
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
        margin-top: 1rem;
      }

      /* Delete Button */
      .delete-button {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: rgb(206, 23, 23);
        border: none;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0px 0px 20px rgba(0, 0, 0, 0.164);
        cursor: pointer;
        transition: all 0.3s ease;
        overflow: hidden;
        position: relative;
      }

      .delete-button:hover {
        width: 90px;
        border-radius: 50px;
        background-color: rgb(255, 69, 69);
      }

      /* Edit Button */
      .edit-button {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background-color: rgb(115, 59, 161);
        border: none;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0px 0px 20px rgba(0, 0, 0, 0.164);
        cursor: pointer;
        transition: all 0.3s ease;
        overflow: hidden;
        position: relative;
        text-decoration: none !important;
      }

      .edit-button:hover {
        width: 120px;
        border-radius: 50px;
        background-color: rgb(115, 59, 161);
      }

      /* Search and Filters */
      .search-container {
        position: relative;
      }

      .search-container i {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #6b7280;
      }

      .search-container input {
        padding-left: 2.5rem;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
      }

      /* Modal Styles */
      .modal-content {
        border-radius: 16px;
        border: none;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
      }

      .modal-header {
        border-bottom: 1px solid #e5e7eb;
        padding: 1.5rem;
      }

      .modal-body {
        padding: 1.5rem;
      }

      .modal-footer {
        border-top: 1px solid #e5e7eb;
        padding: 1.5rem;
      }

      /* Form Styles */
      .form-label {
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.5rem;
      }

      .form-control,
      .form-select {
        border-radius: 10px;
        padding: 0.75rem 1rem;
        border: 1px solid #e5e7eb;
        transition: all 0.2s ease;
      }

      .form-control:focus,
      .form-select:focus {
        border-color: var(--lootbox-purple);
        box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
      }

      /* Button Styles */
      .btn-primary {
        background: var(--lootbox-gradient);
        border: none;
        border-radius: 10px;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        transition: all 0.2s ease;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(124, 58, 237, 0.3);
      }

      .btn-outline-secondary {
        border-radius: 10px;
        padding: 0.75rem 1.5rem;
        font-weight: 500;
      }

      /* Mobile Responsive */
      @media (max-width: 768px) {
        .sidebar {
          transform: translateX(-100%);
        }

        .sidebar.show {
          transform: translateX(0);
        }

        .main-content {
          margin-left: 0;
        }

        .stats-card {
          margin-bottom: 1rem;
        }
      }

      /* Loading Animation */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .fade-in {
        animation: fadeIn 0.5s ease forwards;
      }

      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
      }

      ::-webkit-scrollbar-thumb {
        background: #c4b5fd;
        border-radius: 10px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: var(--lootbox-purple);
      }

      /* Toast Notification */
      .toast {
        border-radius: 10px;
        box-shadow: var(--card-shadow);
      }
    </style>
  </head>
  <body onload="initPage()">
    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
      <div
        class="p-3 border-bottom d-flex justify-content-between align-items-center"
      >
        <span class="fw-semibold">Vendor Panel</span>
        <button class="btn btn-link d-md-none" onclick="toggleSidebar()">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>

      <div class="p-3">
        <div class="mb-4">
          <p class="text-muted small mb-2">DASHBOARD</p>
          <a
            href="../Vendor/Vdashboard.html"
            class="nav-link d-flex align-items-center"
          >
            <i class="bi bi-shop me-2"></i>
            Overview
          </a>
        </div>

        <div class="mb-4">
          <p class="text-muted small mb-2">CATALOG</p>
          <a
            href="../Vendor/Vproduct.html"
            class="nav-link active d-flex align-items-center"
          >
            <i class="bi bi-box me-2"></i>
            Products
          </a>
          <a
            href="../Vendor/Vorders.html"
            class="nav-link d-flex align-items-center"
          >
            <i class="bi bi-cart me-2"></i>
            Orders
          </a>
        </div>

        <div class="mb-4">
          <p class="text-muted small mb-2">ACCOUNT</p>
          <a href="./profile.html" class="nav-link d-flex align-items-center">
            <i class="bi bi-person me-2"></i>
            Profile
          </a>
          <a href="/vendor/settings" class="nav-link d-flex align-items-center">
            <i class="bi bi-gear me-2"></i>
            Settings
          </a>
        </div>
      </div>

      <div class="mt-auto p-3 border-top">
        <a
          href="#"
          onclick="logout()"
          class="nav-link text-danger d-flex align-items-center"
        >
          <i class="bi bi-box-arrow-right me-2"></i>
          Logout
        </a>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Navbar -->
      <nav
        class="navbar navbar-expand-lg navbar-light bg-white border-bottom px-4"
      >
        <div class="container-fluid">
          <button
            class="navbar-toggler border-0 d-md-none"
            type="button"
            onclick="toggleSidebar()"
          >
            <span class="navbar-toggler-icon"></span>
          </button>

          <a class="navbar-brand d-flex align-items-center" href="/vendor">
            <span class="fw-bold text-purple me-2">Lootbox</span>
            <span class="badge bg-purple">Vendor</span>
          </a>

          <div class="d-flex align-items-center gap-3">
            <div class="search-container d-none d-md-block">
              <i class="bi bi-search"></i>
              <input
                type="search"
                class="form-control"
                placeholder="Search products..."
                id="searchInput"
                onkeyup="filterProducts()"
              />
            </div>

            <button class="btn btn-link position-relative">
              <i class="bi bi-bell"></i>
              <span
                class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle"
              >
                <span class="visually-hidden">New alerts</span>
              </span>
            </button>

            <button class="btn btn-link">
              <i class="bi bi-person-circle"></i>
            </button>
            <span
              id="vendorEmail"
              class="d-none d-md-inline text-muted small"
            ></span>
          </div>
        </div>
      </nav>

      <!-- Page Content -->
      <div class="container-fluid py-4">
        <!-- Header -->
        <div
          class="page-header d-flex flex-column flex-md-row justify-content-between align-items-start gap-4"
        >
          <div>
            <h1 class="h3 mb-1">Products</h1>
            <p class="text-muted mb-0">Manage your product catalog</p>
          </div>
          <button
            class="btn btn-primary"
            data-bs-toggle="modal"
            data-bs-target="#productModal"
          >
            <i class="bi bi-plus-lg me-2"></i>Add New Product
          </button>
        </div>

        <!-- Stats Cards -->
        <div class="row g-4 mb-4">
          <div class="col-12 col-sm-6 col-md-3">
            <div class="stats-card fade-in">
              <div class="icon-container products-icon">
                <i class="bi bi-box-seam fs-4"></i>
              </div>
              <span class="text-muted">Total Products</span>
              <h3 class="mb-1" id="totalProducts">0</h3>
            </div>
          </div>

          <div class="col-12 col-sm-6 col-md-3">
            <div class="stats-card fade-in">
              <div class="icon-container sales-icon">
                <i class="bi bi-currency-dollar fs-4"></i>
              </div>
              <span class="text-muted">Total Value</span>
              <h3 class="mb-1" id="totalValue">GH₵0.00</h3>
            </div>
          </div>

          <div class="col-12 col-sm-6 col-md-3">
            <div class="stats-card fade-in">
              <div class="icon-container stock-icon">
                <i class="bi bi-check-circle fs-4"></i>
              </div>
              <span class="text-muted">In Stock</span>
              <h3 class="mb-1" id="inStock">0</h3>
            </div>
          </div>

          <div class="col-12 col-sm-6 col-md-3">
            <div class="stats-card fade-in">
              <div class="icon-container value-icon">
                <i class="bi bi-exclamation-circle fs-4"></i>
              </div>
              <span class="text-muted">Out of Stock</span>
              <h3 class="mb-1" id="outOfStock">0</h3>
            </div>
          </div>
        </div>

        <!-- Search and Filters -->
        <div class="row g-3 mb-4">
          <div class="col-12 col-sm-6 col-md-4">
            <div class="search-container">
              <i class="bi bi-search"></i>
              <input
                type="search"
                class="form-control"
                placeholder="Search products..."
                id="mobileSearchInput"
                onkeyup="filterProducts()"
              />
            </div>
          </div>
          <div class="col-12 col-sm-6 col-md-auto ms-md-auto">
            <div class="d-flex gap-2">
              <select class="form-select" onchange="filterByStatus(this.value)">
                <option value="all">All Status</option>
                <option value="Active">Active</option>
                <option value="Out of Stock">Out of Stock</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Products Grid -->
        <div class="row g-4" id="productsGrid">
          <!-- Products will be loaded here dynamically -->
          <div class="col-12 text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Loading products...</p>
          </div>
        </div>

        <!-- Load More Button -->
        <div
          class="text-center mt-4"
          id="loadMoreContainer"
          style="display: none"
        >
          <button
            class="btn btn-outline-secondary"
            onclick="loadMoreProducts()"
          >
            Load More
          </button>
        </div>
      </div>
    </div>

    <!-- Add Product Modal -->
    <div
      class="modal fade"
      id="productModal"
      tabindex="-1"
      aria-labelledby="productModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <form id="productForm">
            <div class="modal-header">
              <h5 class="modal-title" id="productModalLabel">Add Product</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>
            <div class="modal-body row g-3">
              <div class="col-md-6">
                <label class="form-label">Product Name</label>
                <input
                  type="text"
                  class="form-control"
                  id="productName"
                  placeholder="Enter product name"
                  required
                />
              </div>

              <div class="col-12">
                <label class="form-label">Description</label>
                <textarea
                  class="form-control"
                  id="productDescription"
                  placeholder="Enter product description"
                  rows="3"
                ></textarea>
              </div>

              <div class="col-md-6">
                <label class="form-label">Category</label>
                <input
                  type="text"
                  class="form-control"
                  id="productCategory"
                  placeholder="e.g. Electronics"
                />
              </div>

              <div class="col-md-6">
                <label class="form-label">Brand</label>
                <input
                  type="text"
                  class="form-control"
                  id="productBrand"
                  placeholder="e.g. Samsung, Apple..."
                />
              </div>

              <div class="col-md-6">
                <label class="form-label">Price (GH₵)</label>
                <input
                  type="number"
                  class="form-control"
                  id="productPrice"
                  placeholder="Enter price"
                  required
                  step="0.01"
                />
              </div>

              <div class="col-md-6">
                <label class="form-label">Stock Quantity</label>
                <input
                  type="number"
                  class="form-control"
                  id="productStock"
                  placeholder="Enter stock quantity"
                  required
                />
              </div>

              <div class="col-12">
                <label class="form-label">Product Image</label>
                <div class="mb-3">
                  <img
                    id="productImagePreview"
                    src=""
                    alt="Preview"
                    class="img-fluid mb-2"
                    style="
                      max-height: 150px;
                      display: none;
                      object-fit: cover;
                      border-radius: 8px;
                    "
                  />
                </div>
                <input
                  type="file"
                  class="form-control"
                  id="productImageFile"
                  accept="image/*"
                />
              </div>

              <input type="hidden" id="existingImage" />

              <div class="col-12">
                <label class="form-label">Status</label>
                <select class="form-select" id="productStatus" required>
                  <option value="Active">Active</option>
                  <option value="Out of Stock">Out of Stock</option>
                </select>
              </div>
            </div>
            <div class="modal-footer">
              <input type="hidden" id="productIndex" />
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Cancel
              </button>
              <button type="submit" class="btn btn-primary">
                Save Product
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Toast Container -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
      <div
        id="toastBox"
        class="toast align-items-center text-white bg-success border-0"
        role="alert"
        aria-live="assertive"
        aria-atomic="true"
      >
        <div class="d-flex">
          <div class="toast-body" id="toastMessage">Success!</div>
          <button
            type="button"
            class="btn-close btn-close-white me-2 m-auto"
            data-bs-dismiss="toast"
            aria-label="Close"
          ></button>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS and Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-storage-compat.js"></script>

    <script>
      // Firebase config
      const firebaseConfig = {
        apiKey: "AIzaSyB9jxnU1G6WgE6rRKI_IufJ-abQNE-v7dk",
        authDomain: "lootbox-vproduct.firebaseapp.com",
        projectId: "lootbox-vproduct",
        storageBucket: "lootbox-vproduct.firebasestorage.app",
        messagingSenderId: "753114136209",
        appId: "1:753114136209:web:75f2b96440b32c04c70930",
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const productsCollection = db.collection("products");

      // Global variables
      let products = [];
      let filteredProducts = [];
      let displayCount = 8;

      // Check if user is logged in
      firebase.auth().onAuthStateChanged((user) => {
        if (user) {
          document.getElementById("vendorEmail").textContent = user.email;
          loadProducts();
        } else {
          window.location.href = "../Account/Account.html";
        }
      });

      // Toggle sidebar
      function toggleSidebar() {
        document.getElementById("sidebar").classList.toggle("show");
      }

      // Show a loading popup with custom message
      function showLoading(message = "Please wait...") {
        Swal.fire({
          title: message,
          allowOutsideClick: false,
          showConfirmButton: false,
          didOpen: () => {
            Swal.showLoading();
          },
        });
      }

      // Close the loading popup
      function hideLoading() {
        Swal.close();
      }

      // Show toast notification
      function showToast(message, type = "success") {
        const toastEl = document.getElementById("toastBox");
        const toastBody = document.getElementById("toastMessage");

        toastBody.textContent = message;
        toastEl.classList.remove("bg-success", "bg-danger", "bg-warning");
        toastEl.classList.add(`bg-${type}`);

        const toast = new bootstrap.Toast(toastEl);
        toast.show();
      }

      // Load products from Firebase
      async function loadProducts() {
        try {
          const user = firebase.auth().currentUser;
          if (!user) {
            window.location.href = "../Account/Account.html";
            return;
          }

          // ✅ Only load products for this vendor
          const snapshot = await productsCollection
            .where("vendorId", "==", user.uid)
            .get();

          products = snapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
          }));

          filteredProducts = [...products];
          renderProducts();
          updateStats();
        } catch (error) {
          console.error("Error loading products:", error);
          showToast("Failed to load products", "danger");
        }
      }

      // Render products to the grid
      function renderProducts() {
        const grid = document.getElementById("productsGrid");
        const productsToShow = filteredProducts.slice(0, displayCount);

        if (productsToShow.length === 0) {
          grid.innerHTML = `
            <div class="col-12 text-center py-5">
              <i class="bi bi-box text-muted display-1"></i>
              <h5 class="mt-3 text-muted">No products found</h5>
              <p class="text-muted">Try adjusting your search or add a new product</p>
            </div>
          `;
          document.getElementById("loadMoreContainer").style.display = "none";
          return;
        }

        grid.innerHTML = productsToShow
          .map(
            (p, i) => `
          <div class="col-12 col-sm-6 col-md-4 col-lg-3 fade-in">
            <div class="product-card">
              <div class="img-container">
                <img src="${
                  p.image || "https://via.placeholder.com/300x300?text=No+Image"
                }" alt="${p.name}">
                <span class="badge ${
                  p.status === "Active" ? "bg-success" : "bg-danger"
                } status-badge">${p.status}</span>
              </div>
              <div class="card-body">
                <h5 class="card-title">${p.name}</h5>
                <p class="card-text">${
                  p.description || "No description available"
                }</p>
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="product-price">GH₵${parseFloat(p.price).toFixed(
                    2
                  )}</span>
                  <span class="product-stock">${p.stock} in stock</span>
                </div>
                <div class="product-meta">
                  ${
                    p.category
                      ? `<span class="me-2"><i class="bi bi-tag me-1"></i>${p.category}</span>`
                      : ""
                  }
                  ${
                    p.brand
                      ? `<span><i class="bi bi-building me-1"></i>${p.brand}</span>`
                      : ""
                  }
                </div>
                <div class="action-buttons">
                  <button class="edit-button" onclick="editProduct('${p.id}')">
                    <svg class="edit-svgIcon" viewBox="0 0 512 512" width="17">
                      <path d="M410.3 231l11.3-11.3-33.9-33.9-62.1-62.1L291.7 89.8l-11.3 11.3-22.6 22.6L58.6 322.9c-10.4 10.4-18 23.3-22.2 37.4L1 480.7c-2.5 8.4-.2 17.5 6.1 23.7s15.3 8.5 23.7 6.1l120.3-35.4c14.1-4.2 27-11.8 37.4-22.2L387.7 253.7 410.3 231zM160 399.4l-9.1 22.7c-4 3.1-8.5 5.4-13.3 6.9L59.4 452l23-78.1c1.4-4.9 3.8-9.4 6.9-13.3l22.7-9.1v32c0 8.8 7.2 16 16 16h32zM362.7 18.7L348.3 33.2 325.7 55.8 314.3 67.1l33.9 33.9 62.1 62.1 33.9 33.9 11.3-11.3 22.6-22.6 14.5-14.5c25-25 25-65.5 0-90.5L453.3 18.7c-25-25-65.5-25-90.5 0zm-47.4 168l-144 144c-6.2 6.2-16.4 6.2-22.6 0s-6.2-16.4 0-22.6l144-144c6.2-6.2 16.4-6.2 22.6 0s6.2 16.4 0 22.6z" fill="white"></path>
                    </svg>
                  </button>
                  <button class="delete-button" onclick="deleteProduct('${
                    p.id
                  }')">
                    <svg class="delete-svgIcon" viewBox="0 0 448 512" width="15">
                      <path d="M135.2 17.7L128 32H32C14.3 32 0 46.3 0 64S14.3 96 32 96H416c17.7 0 32-14.3 32-32s-14.3-32-32-32H320l-7.2-14.3C307.4 6.8 296.3 0 284.2 0H163.8c-12.1 0-23.2 6.8-28.6 17.7zM416 128H32L53.2 467c1.6 25.3 22.6 45 47.9 45H346.9c25.3 0 46.3-19.7 47.9-45L416 128z" fill="white"></path>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          </div>
        `
          )
          .join("");

        // Show/hide load more button
        document.getElementById("loadMoreContainer").style.display =
          filteredProducts.length > displayCount ? "block" : "none";
      }

      // Update statistics
      function updateStats() {
        const totalProducts = products.length;
        const totalValue = products.reduce(
          (sum, product) =>
            sum + parseFloat(product.price) * parseInt(product.stock),
          0
        );
        const inStock = products.filter(
          (product) => product.status === "Active"
        ).length;
        const outOfStock = products.filter(
          (product) => product.status === "Out of Stock"
        ).length;

        document.getElementById("totalProducts").textContent = totalProducts;
        document.getElementById(
          "totalValue"
        ).textContent = `GH₵${totalValue.toFixed(2)}`;
        document.getElementById("inStock").textContent = inStock;
        document.getElementById("outOfStock").textContent = outOfStock;
      }

      // Filter products based on search input
      function filterProducts() {
        const searchTerm =
          document.getElementById("searchInput").value.toLowerCase() ||
          document.getElementById("mobileSearchInput").value.toLowerCase();

        filteredProducts = products.filter(
          (product) =>
            product.name.toLowerCase().includes(searchTerm) ||
            (product.description &&
              product.description.toLowerCase().includes(searchTerm)) ||
            (product.category &&
              product.category.toLowerCase().includes(searchTerm)) ||
            (product.brand && product.brand.toLowerCase().includes(searchTerm))
        );

        displayCount = 8;
        renderProducts();
      }

      // Filter by status
      function filterByStatus(status) {
        if (status === "all") {
          filteredProducts = [...products];
        } else {
          filteredProducts = products.filter(
            (product) => product.status === status
          );
        }

        displayCount = 8;
        renderProducts();
      }

      // Load more products
      function loadMoreProducts() {
        displayCount += 8;
        renderProducts();
      }

      // Save product to Firebase
      async function saveProduct(product, id = null) {
        const user = firebase.auth().currentUser;
        if (!user) {
          Swal.fire({
            icon: "error",
            title: "Not Authenticated",
            text: "Please log in to continue.",
            confirmButtonColor: "#127d3a",
          });
          return;
        }

        // Add vendor info + timestamps
        product.vendorId = user.uid;
        product.vendorName = user.displayName || user.email;

        if (!id) {
          product.createdAt = firebase.firestore.FieldValue.serverTimestamp();
        } else {
          product.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
        }

        try {
          showLoading(id ? "Updating product..." : "Uploading product...");

          if (id) {
            // Update existing product
            await productsCollection.doc(id).update(product);
            showToast("Product updated successfully", "success");
          } else {
            // Add new product
            await productsCollection.add(product);
            showToast("Product uploaded successfully", "success");
          }

          hideLoading();
          bootstrap.Modal.getInstance(
            document.getElementById("productModal")
          ).hide();
          loadProducts();
        } catch (error) {
          console.error("Error saving product:", error);
          hideLoading();
          showToast("Failed to save product", "danger");
        }
      }

      // Edit product
      async function editProduct(id) {
        try {
          const doc = await productsCollection.doc(id).get();
          const p = doc.data();

          document.getElementById("productName").value = p.name;
          document.getElementById("productPrice").value = p.price;
          document.getElementById("productStock").value = p.stock;
          document.getElementById("productStatus").value = p.status;
          document.getElementById("productIndex").value = id;
          document.getElementById("productDescription").value =
            p.description || "";
          document.getElementById("productCategory").value = p.category || "";
          document.getElementById("productBrand").value = p.brand || "";

          // Show the existing image and store its value
          if (p.image) {
            document.getElementById("productImagePreview").src = p.image;
            document.getElementById("productImagePreview").style.display =
              "block";
            document.getElementById("existingImage").value = p.image;
          }

          // Clear the file input
          document.getElementById("productImageFile").value = "";

          new bootstrap.Modal(document.getElementById("productModal")).show();
        } catch (error) {
          console.error("Error loading product for edit:", error);
          showToast("Failed to load product", "danger");
        }
      }

      // Delete product
      async function deleteProduct(id) {
        const result = await Swal.fire({
          title: "Are you sure?",
          text: "This action cannot be undone.",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#d33",
          cancelButtonColor: "#3085d6",
          confirmButtonText: "Yes, delete it!",
          cancelButtonText: "Cancel",
        });

        if (!result.isConfirmed) return;

        try {
          await productsCollection.doc(id).delete();
          showToast("Product deleted successfully", "success");
          loadProducts();
        } catch (error) {
          console.error("Delete failed:", error);
          showToast("Failed to delete product", "danger");
        }
      }

      // Logout function
      async function logout() {
        const result = await Swal.fire({
          title: "Are you sure?",
          text: "Do you really want to log out?",
          icon: "question",
          showCancelButton: true,
          confirmButtonColor: "#127d3a",
          cancelButtonColor: "#6c757d",
          confirmButtonText: "Yes, log me out",
          cancelButtonText: "Cancel",
        });

        if (!result.isConfirmed) return;

        try {
          await firebase.auth().signOut();
          window.location.href = "./login.html";
        } catch (err) {
          showToast("Logout failed", "danger");
        }
      }

      // Initialize page

      // Form submission handler
      document
        .getElementById("productForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const name = document.getElementById("productName").value;
          const price = parseFloat(
            document.getElementById("productPrice").value
          );
          const stock = parseInt(document.getElementById("productStock").value);
          const status = document.getElementById("productStatus").value;
          const id = document.getElementById("productIndex").value;
          const description =
            document.getElementById("productDescription").value;
          const category = document.getElementById("productCategory").value;
          const brand = document.getElementById("productBrand").value;

          const fileInput = document.getElementById("productImageFile");
          const file = fileInput.files[0];

          let imageUrl = document.getElementById("existingImage").value;

          try {
            // Upload new image if selected
            if (file) {
              const storageRef = firebase.storage().ref();
              const imageRef = storageRef.child(
                `productImages/${Date.now()}_${file.name}`
              );
              const snapshot = await imageRef.put(file);
              imageUrl = await snapshot.ref.getDownloadURL();
            }

            const product = {
              name,
              price,
              stock,
              image: imageUrl,
              status,
              description,
              category,
              brand,
            };
            await saveProduct(product, id);
          } catch (err) {
            console.error("Upload error:", err);
            showToast("Failed to upload image", "danger");
          }
        });

      // Image preview
      document
        .getElementById("productImageFile")
        .addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (event) {
              document.getElementById("productImagePreview").src =
                event.target.result;
              document.getElementById("productImagePreview").style.display =
                "block";
            };
            reader.readAsDataURL(file);
          }
        });
    </script>
  </body>
</html>
