<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lootbox Vendor - Dashboard</title>
    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
    <style>
      :root {
        --lootbox-purple: #7c3aed;
        --lootbox-purple-light: #ede9fe;
      }

      /* Sidebar Styles */
      .sidebar {
        width: 250px;
        height: 100vh;
        position: fixed;
        left: 0;
        top: 0;
        background: #fff;
        border-right: 1px solid #e5e7eb;
      }

      .main-content {
        margin-left: 250px;
      }

      .nav-link {
        color: #64748b;
        padding: 0.75rem 1rem;
        border-radius: 0.375rem;
        margin: 0.25rem 0;
      }

      .nav-link:hover,
      .nav-link.active {
        background-color: var(--lootbox-purple-light);
        color: var(--lootbox-purple);
      }

      .nav-link.active {
        background-color: var(--lootbox-purple);
        color: white;
      }

      /* Stats Card */
      .stats-card {
        background: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .stats-card .trend-up {
        color: #059669;
      }

      .stats-card .trend-down {
        color: #dc2626;
      }

      /* Product Card */
      .product-card {
        position: relative;
        overflow: hidden;
        border-radius: 0.5rem;
      }

      .product-card img {
        aspect-ratio: 1;
        object-fit: cover;
        transition: transform 0.2s;
      }

      .product-card:hover img {
        transform: scale(1.05);
      }

      /* Mobile Responsive */
      @media (max-width: 768px) {
        .sidebar {
          transform: translateX(-100%);
          z-index: 1000;
          transition: transform 0.3s ease-in-out;
        }

        .sidebar.show {
          transform: translateX(0);
        }

        .main-content {
          margin-left: 0;
        }
      }
    </style>
  </head>
  <body>
    <!-- Sidebar (Same as orders page) -->
    <nav class="sidebar" id="sidebar">
      <div
        class="p-3 border-bottom d-flex justify-content-between align-items-center"
      >
        <span class="fw-semibold">Vendor Panel</span>
        <button class="btn btn-link d-md-none" onclick="toggleSidebar()">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>

      <div class="p-3">
        <div class="mb-4">
          <p class="text-muted small mb-2">DASHBOARD</p>
          <a
            href="../Vendor/Vdashboard.html"
            class="nav-link active d-flex align-items-center"
          >
            <i class="bi bi-shop me-2"></i>
            Overview
          </a>
        </div>

        <div class="mb-4">
          <p class="text-muted small mb-2">CATALOG</p>
          <a
            href="../Vendor/Vproduct.html"
            class="nav-link d-flex align-items-center"
          >
            <i class="bi bi-box me-2"></i>
            Products
          </a>
          <a
            href="../Vendor/Vorders.html"
            class="nav-link d-flex align-items-center"
          >
            <i class="bi bi-cart me-2"></i>
            Orders
          </a>
        </div>

        <div class="mb-4">
          <p class="text-muted small mb-2">ACCOUNT</p>
          <a href="/vendor/profile" class="nav-link d-flex align-items-center">
            <i class="bi bi-person me-2"></i>
            Profile
          </a>
          <a href="/vendor/settings" class="nav-link d-flex align-items-center">
            <i class="bi bi-gear me-2"></i>
            Settings
          </a>
        </div>
      </div>

      <div class="mt-auto p-3 border-top">
        <a
          href="/logout"
          class="nav-link text-danger d-flex align-items-center"
        >
          <i class="bi bi-box-arrow-right me-2"></i>
          Logout
        </a>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Navbar -->
      <nav
        class="navbar navbar-expand-lg navbar-light bg-white border-bottom px-4"
      >
        <div class="container-fluid">
          <button
            class="navbar-toggler border-0 d-md-none"
            type="button"
            onclick="toggleSidebar()"
          >
            <span class="navbar-toggler-icon"></span>
          </button>

          <a class="navbar-brand d-flex align-items-center" href="/vendor">
            <span class="fw-bold text-purple me-2">Lootbox</span>
            <span class="badge bg-purple">Vendor</span>
          </a>

          <div class="d-flex align-items-center gap-3">
            <div class="position-relative d-none d-md-block">
              <i
                class="bi bi-search position-absolute top-50 translate-middle-y ms-3"
              ></i>
              <input
                type="search"
                class="form-control ps-5"
                placeholder="Search products..."
              />
            </div>

            <button class="btn btn-link position-relative">
              <i class="bi bi-bell"></i>
              <span
                class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle"
              >
                <span class="visually-hidden">New alerts</span>
              </span>
            </button>

            <button class="btn btn-link">
              <i class="bi bi-person-circle"></i>
            </button>
          </div>
        </div>
      </nav>

      <!-- Page Content -->
      <div class="container-fluid py-4">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <h1 class="h3 mb-1">Dashboard</h1>
            <p class="text-muted">
              Welcome back! Here's an overview of your store.
            </p>
          </div>
          <button
            onclick="window.location.href='../Vendor/Vproduct.html'"
            class="btn btn-primary"
            style="
              background-color: var(--lootbox-purple);
              border-color: var(--lootbox-purple);
            "
          >
            <i class="bi bi-plus-lg me-2"></i>
            Add New Product
          </button>
        </div>

        <!-- Add this right after your header section, before the Stats Cards -->
        <div class="mb-3">
          <button onclick="testLogin()" class="btn btn-secondary me-2">
            Test Login
          </button>
          <button onclick="addTestData()" class="btn btn-primary">
            Add Test Data
          </button>
        </div>

        <!-- Stats Cards -->
        <div class="row g-4 mb-4">
          <!-- Total Sales -->
          <div class="col-12 col-sm-6 col-lg-3">
            <div class="stats-card">
              <div class="d-flex justify-content-between mb-2">
                <span class="text-muted">Total Sales</span>
                <i class="bi bi-cart text-muted"></i>
              </div>
              <h3 class="mb-1" data-stat="total-sales">GH₵0.00</h3>
              <p class="mb-0 small">
                <span class="trend-up">
                  <i class="bi bi-arrow-up"></i>
                  12%
                </span>
                <span class="text-muted ms-1">from last month</span>
              </p>
            </div>
          </div>

          <!-- Orders -->
          <div class="col-12 col-sm-6 col-lg-3">
            <div class="stats-card">
              <div class="d-flex justify-content-between mb-2">
                <span class="text-muted">Orders</span>
                <i class="bi bi-bag text-muted"></i>
              </div>
              <h3 class="mb-1" data-stat="total-orders">145</h3>
              <p class="mb-0 small">
                <span class="trend-up">
                  <i class="bi bi-arrow-up"></i>
                  8%
                </span>
                <span class="text-muted ms-1">from last month</span>
              </p>
            </div>
          </div>

          <!-- Customers -->
          <div class="col-12 col-sm-6 col-lg-3">
            <div class="stats-card">
              <div class="d-flex justify-content-between mb-2">
                <span class="text-muted">Customers</span>
                <i class="bi bi-people text-muted"></i>
              </div>
              <h3 class="mb-1">2,310</h3>
              <p class="mb-0 small">
                <span class="trend-up">
                  <i class="bi bi-arrow-up"></i>
                  2%
                </span>
                <span class="text-muted ms-1">new customers</span>
              </p>
            </div>
          </div>

          <!-- Conversion Rate -->
          <div class="col-12 col-sm-6 col-lg-3">
            <div class="stats-card">
              <div class="d-flex justify-content-between mb-2">
                <span class="text-muted">Conversion Rate</span>
                <i class="bi bi-graph-up text-muted"></i>
              </div>
              <h3 class="mb-1">3.2%</h3>
              <p class="mb-0 small">
                <span class="trend-down">
                  <i class="bi bi-arrow-down"></i>
                  0.4%
                </span>
                <span class="text-muted ms-1">from last month</span>
              </p>
            </div>
          </div>
        </div>

        <!-- Recent Orders and Top Products -->
        <div class="row g-4">
          <!-- Recent Orders -->
          <div class="col-12 col-lg-8">
            <div class="card">
              <div class="card-header bg-white py-3">
                <h5 class="card-title mb-0">Recent Orders</h5>
              </div>
              <div class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead>
                    <tr>
                      <th>Order ID</th>
                      <th>Customer</th>
                      <th>Date</th>
                      <th>Amount</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody id="recent-orders-table">
                    <tr>
                      <td>ORD-001</td>
                      <td>John Smith</td>
                      <td>2025-04-26</td>
                      <td>GH&#8373;125.99</td>
                      <td>
                        <span class="badge bg-success">Completed</span>
                      </td>
                    </tr>
                    <tr>
                      <td>ORD-002</td>
                      <td>Sarah Johnson</td>
                      <td>2025-04-25</td>
                      <td>GH&#8373;89.99</td>
                      <td>
                        <span class="badge bg-warning text-dark"
                          >Processing</span
                        >
                      </td>
                    </tr>
                    <tr>
                      <td>ORD-003</td>
                      <td>Mike Williams</td>
                      <td>2025-04-24</td>
                      <td>GH&#8373;45.50</td>
                      <td>
                        <span class="badge bg-success">Completed</span>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Top Products -->
          <div class="col-12 col-lg-4">
            <div class="card">
              <div
                class="card-header bg-white py-3 d-flex justify-content-between align-items-center"
              >
                <h5 class="card-title mb-0">Top Products</h5>
                <a
                  href="#"
                  class="text-decoration-none"
                  style="color: var(--lootbox-purple)"
                  >View All</a
                >
              </div>
              <div class="card-body" id="top-products">
                <!-- Product Item -->
                <div class="d-flex align-items-center mb-3">
                  <img
                    src="https://via.placeholder.com/50"
                    class="rounded me-3"
                    alt="Product"
                  />
                  <div class="flex-grow-1">
                    <h6 class="mb-0">Gaming Mouse</h6>
                    <div
                      class="d-flex justify-content-between align-items-center mt-1"
                    >
                      <small class="text-muted">15 in stock</small>
                      <span class="fw-medium">GH&#8373;59.99</span>
                    </div>
                  </div>
                </div>

                <!-- Product Item -->
                <div class="d-flex align-items-center mb-3">
                  <img
                    src="https://via.placeholder.com/50"
                    class="rounded me-3"
                    alt="Product"
                  />
                  <div class="flex-grow-1">
                    <h6 class="mb-0">Mechanical Keyboard</h6>
                    <div
                      class="d-flex justify-content-between align-items-center mt-1"
                    >
                      <small class="text-muted">8 in stock</small>
                      <span class="fw-medium">GH&#8373;129.99</span>
                    </div>
                  </div>
                </div>

                <!-- Product Item -->
                <div class="d-flex align-items-center">
                  <img
                    src="https://via.placeholder.com/50"
                    class="rounded me-3"
                    alt="Product"
                  />
                  <div class="flex-grow-1">
                    <h6 class="mb-0">Gaming Headset</h6>
                    <div
                      class="d-flex justify-content-between align-items-center mt-1"
                    >
                      <small class="text-muted">Out of stock</small>
                      <span class="fw-medium">GH&#8373;89.99</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Featured Products -->
        <div class="mt-4">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="mb-0">Featured Products</h5>
            <a
              href="#"
              class="text-decoration-none"
              style="color: var(--lootbox-purple)"
              >View All Products</a
            >
          </div>

          <div class="row g-4">
            <!-- Product Card -->
            <div class="col-12 col-sm-6 col-lg-3">
              <div class="card product-card">
                <img
                  src="https://via.placeholder.com/300"
                  class="card-img-top"
                  alt="Product"
                />
                <div class="card-body">
                  <h6 class="card-title mb-1">Gaming Mouse</h6>
                  <div
                    class="d-flex justify-content-between align-items-center"
                  >
                    <small class="text-muted">15 in stock</small>
                    <span class="fw-bold">GH&#8373;59.99</span>
                  </div>
                </div>
                <div class="card-footer bg-white border-top-0 pt-0">
                  <button class="btn btn-outline-secondary w-100">
                    <i class="bi bi-pencil me-2"></i>
                    Edit
                  </button>
                </div>
              </div>
            </div>

            <!-- More Product Cards -->
            <!-- Copy the above product card structure for more products -->
          </div>
        </div>
      </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-storage-compat.js"></script>

    <script>
      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyB9jxnU1G6WgE6rRKI_IufJ-abQNE-v7dk",
        authDomain: "lootbox-vproduct.firebaseapp.com",
        projectId: "lootbox-vproduct",
        storageBucket: "lootbox-vproduct.firebasestorage.app",
        messagingSenderId: "753114136209",
        appId: "1:753114136209:web:75f2b96440b32c04c70930",
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      // Auth state observer
      firebase.auth().onAuthStateChanged((user) => {
        if (user) {
          loadDashboardData(user.uid);
        } else {
          window.location.href = "../Account/Account.html"; // Redirect to login if not authenticated
        }
      });

      // Add this function to handle real-time updates
      function listenToOrderUpdates(vendorId) {
        // Listen for real-time order updates
        db.collection("orders")
          .where("vendorId", "==", vendorId)
          .orderBy("date", "desc")
          .onSnapshot((snapshot) => {
            let totalSales = 0;
            const orders = [];

            snapshot.forEach((doc) => {
              const order = { id: doc.id, ...doc.data() };
              orders.push(order);
              totalSales += order.total || 0;
            });

            // Update total sales
            document.querySelector(
              '[data-stat="total-sales"]'
            ).textContent = `GH₵${totalSales.toFixed(2)}`;

            // Update total orders
            document.querySelector('[data-stat="total-orders"]').textContent =
              orders.length;

            // Update recent orders table
            const recentOrders = orders.slice(0, 5);
            const ordersTableBody = document.querySelector(
              "#recent-orders-table"
            );
            ordersTableBody.innerHTML = recentOrders
              .map(
                (order) => `
          <tr>
            <td>${order.id.slice(0, 8)}</td>
            <td>${order.customerName}</td>
            <td>${new Date(order.date?.toDate()).toLocaleDateString()}</td>
            <td>GH₵${order.total.toFixed(2)}</td>
            <td>
              <span class="badge bg-${getStatusColor(order.status)}">
                ${order.status}
              </span>
            </td>
          </tr>
        `
              )
              .join("");
          });

        // Listen for real-time product updates
        db.collection("products")
          .where("vendorId", "==", vendorId)
          .orderBy("sales", "desc")
          .onSnapshot((snapshot) => {
            const products = [];
            snapshot.forEach((doc) => {
              products.push({ id: doc.id, ...doc.data() });
            });

            // Update top products
            const topProducts = products.slice(0, 3);
            const topProductsContainer =
              document.querySelector("#top-products");
            topProductsContainer.innerHTML = topProducts
              .map(
                (product) => `
          <div class="d-flex align-items-center mb-3">
            <img src="${product.image || "https://placehold.co/50x50"}" 
                 class="rounded me-3" alt="${product.name}" 
                 style="width: 50px; height: 50px; object-fit: cover;">
            <div class="flex-grow-1">
              <h6 class="mb-0">${product.name}</h6>
              <div class="d-flex justify-content-between align-items-center mt-1">
                <small class="text-muted">${product.stock} in stock</small>
                <span class="fw-medium">GH₵${product.price}</span>
              </div>
            </div>
          </div>
        `
              )
              .join("");
          });
      }

      // Modify your existing onAuthStateChanged to use the new listener
      firebase.auth().onAuthStateChanged((user) => {
        if (user) {
          // Start listening for real-time updates
          listenToOrderUpdates(user.uid);
        } else {
          window.location.href = "../Account/Account.html";
        }
      });

      async function loadDashboardData(vendorId) {
        console.log("Loading dashboard data for vendor:", vendorId);
        try {
          // Get products collection
          const productsSnapshot = await db
            .collection("products")
            .where("vendorId", "==", vendorId)
            .get();

          console.log("Products found:", productsSnapshot.size);

          // Get orders collection (assuming you have one)
          const ordersSnapshot = await db
            .collection("orders")
            .where("vendorId", "==", vendorId)
            .get();

          console.log("Orders found:", ordersSnapshot.size);

          // Calculate dashboard metrics
          const totalProducts = productsSnapshot.size;
          let totalSales = 0;
          let totalOrders = ordersSnapshot.size;

          // Calculate total sales from orders
          ordersSnapshot.forEach((doc) => {
            const order = doc.data();
            totalSales += order.total || 0;
          });

          // Update dashboard stats
          document.querySelector(
            '[data-stat="total-sales"]'
          ).textContent = `GH₵${totalSales.toFixed(2)}`;
          document.querySelector('[data-stat="total-orders"]').textContent =
            totalOrders;

          // Load top products
          const topProducts = productsSnapshot.docs
            .map((doc) => ({ id: doc.id, ...doc.data() }))
            .sort((a, b) => (b.sales || 0) - (a.sales || 0))
            .slice(0, 3);

          // Update top products section
          const topProductsContainer = document.querySelector("#top-products");
          topProductsContainer.innerHTML = topProducts
            .map(
              (product) => `
            <div class="d-flex align-items-center mb-3">
              <img src="${product.image || "https://via.placeholder.com/50"}" 
                   class="rounded me-3" alt="${product.name}" 
                   style="width: 50px; height: 50px; object-fit: cover;">
              <div class="flex-grow-1">
                <h6 class="mb-0">${product.name}</h6>
                <div class="d-flex justify-content-between align-items-center mt-1">
                  <small class="text-muted">${product.stock} in stock</small>
                  <span class="fw-medium">GH₵${product.price}</span>
                </div>
              </div>
            </div>
          `
            )
            .join("");

          // Load recent orders
          const recentOrders = ordersSnapshot.docs
            .map((doc) => ({ id: doc.id, ...doc.data() }))
            .sort((a, b) => b.date - a.date)
            .slice(0, 5);

          // Update recent orders table
          const ordersTableBody = document.querySelector(
            "#recent-orders-table"
          );
          ordersTableBody.innerHTML = recentOrders
            .map(
              (order) => `
            <tr>
              <td>${order.id}</td>
              <td>${order.customerName}</td>
              <td>${new Date(order.date).toLocaleDateString()}</td>
              <td>GH₵${order.total.toFixed(2)}</td>
              <td>
                <span class="badge bg-${getStatusColor(order.status)}">${
                order.status
              }</span>
              </td>
            </tr>
          `
            )
            .join("");
        } catch (error) {
          console.error("Error loading dashboard data:", error);
        }
      }

      function getStatusColor(status) {
        switch (status?.toLowerCase()) {
          case "completed":
            return "success";
          case "processing":
            return "warning text-dark";
          case "cancelled":
            return "danger";
          default:
            return "secondary";
        }
      }

      // Test Login function
      async function testLogin() {
        try {
          // Use test credentials - replace with your test vendor account
          await firebase
            .auth()
            .signInWithEmailAndPassword(
              "testvendor@example.com",
              "password123"
            );
          console.log("Logged in successfully");
        } catch (error) {
          console.error("Login failed:", error);
        }
      }

      // Update your addTestData function to include error details
      async function addTestData() {
        try {
          const user = firebase.auth().currentUser;
          if (!user) {
            alert("Please login first!");
            return;
          }
          console.log("Adding test data for user:", user.uid);

          // Add test products
          const products = [
            {
              name: "Gaming Mouse",
              price: 59.99,
              stock: 15,
              image: "https://placehold.co/50x50",
              vendorId: user.uid,
              sales: 5,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            },
            {
              name: "Mechanical Keyboard",
              price: 129.99,
              stock: 8,
              image: "https://placehold.co/50x50",
              vendorId: user.uid,
              sales: 3,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            },
          ];

          // Add products to Firebase
          for (const product of products) {
            console.log("Adding product:", product);
            await db.collection("products").add(product);
          }

          console.log("Products added successfully");

          // Add orders with proper timestamp
          const orders = [
            {
              customerName: "John Smith",
              date: firebase.firestore.FieldValue.serverTimestamp(),
              total: 125.99,
              status: "completed",
              vendorId: user.uid,
            },
            {
              customerName: "Sarah Johnson",
              date: firebase.firestore.FieldValue.serverTimestamp(),
              total: 89.99,
              status: "processing",
              vendorId: user.uid,
            },
          ];

          // Add orders to Firebase
          for (const order of orders) {
            console.log("Adding order:", order);
            await db.collection("orders").add(order);
          }

          console.log("Orders added successfully");
          alert("Test data added successfully!");
          loadDashboardData(user.uid);
        } catch (error) {
          console.error("Detailed error:", error);
          alert(
            `Error adding test data: ${error.message}\nCheck console for details`
          );
        }
      }
    </script>

    <!-- Bootstrap JS and Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      function toggleSidebar() {
        document.getElementById("sidebar").classList.toggle("show");
      }
    </script>
  </body>
</html>
